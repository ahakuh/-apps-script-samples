<script>
  const Utils = {
    KEY: {
      TOKEN: "_token",
      PATH: "_path",
      DARK: "_dark"
    }
  }

  Utils.request = async (functionName, params={}) => {
    console.info("Running function: Utils.request(%s(%s))",functionName,JSON.stringify(params));
    // console.log(typeof JSON.stringify(params))
    return new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler((response) => {
          let data = JSON.parse(response)
          // console.info(data)
          return resolve(data)
          })
        .withFailureHandler((err) => {
            console.error(err)
            return reject(err)
          })
        [functionName](JSON.stringify(params))
    })
  }

  Utils.setToken = (token) => {
    if (typeof token === "object") token = JSON.stringify(token)
    try{
      localStorage.setItem(Utils.KEY.TOKEN, token)
    }catch(err){
      // pass
      console.log(err)
    }
  }

  Utils.getToken = () => {
    try{
      return localStorage.getItem(Utils.KEY.TOKEN)
    }catch(err){
      // pass
      console.log(err)
    }
  }

  /**
  * run something asynchronously
  * @param {string} name the name in whitelistedactions
  * @param {[...]} the args
  * @return {Promise} a promise
  */
  Utils.run = (name, ...runArgs) => {
    console.info("Running function: %s(%s)",name,JSON.stringify(...runArgs));

    // this will return a promise
    return new Promise(function ( resolve , reject ) {
      
      google.script.run
    
      .withFailureHandler (function(err) {
        console.info('Error:',err);
        reject (err);
      })
    
      .withSuccessHandler (function(result) {
        // console.log(`typeof result: ${typeof result}`)
        // typeof result === 'string' ? (console.log(JSON.parse(result)),resolve (JSON.parse(result))) : (console.log(result),resolve (result))
        resolve (result)
      })
    
      .runWhitelist (name,...runArgs); 
    })
  
  };
</script>
